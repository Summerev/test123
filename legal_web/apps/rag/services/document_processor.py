# apps/rag/services/document_processor.py
import re
import PyPDF2
import docx
from typing import List, Dict, Any, Tuple, Optional

# ê³„ì•½ì„œ ìœ í˜•ë³„ ì „ë¬¸ ìš©ì–´ ë°ì´í„°ë² ì´ìŠ¤
CONTRACT_TYPES_TERMS = {
    "ê·¼ë¡œê³„ì•½ì„œ": ["ê·¼ë¡œì‹œê°„", "ì„ê¸ˆ", "í‡´ì§ê¸ˆ", "ì—°ì°¨íœ´ê°€", "ìˆ˜ìŠµê¸°ê°„", "ê·¼ë¡œê¸°ì¤€ë²•", "ê³„ì•½ê¸°ê°„", "í•´ê³ ", "ì—…ë¬´ë‚´ìš©", "ë³µë¬´ê·œì •", "ì—°ì¥ê·¼ë¡œ", "ì•¼ê°„ê·¼ë¡œ", "íœ´ê²Œì‹œê°„", "ì§ë¬´ê¸°ìˆ ì„œ", "ì·¨ì—…ê·œì¹™", "ë³µë¦¬í›„ìƒ", "ì§ê¸‰ì²´ê³„", "ê²½ë ¥ì§", "ì •ê·œì§", "ì§ì¥ ë‚´ ê´´ë¡­í˜ ë°©ì§€"],
    "ìš©ì—­ê³„ì•½ì„œ": ["ìš©ì—­ì œê³µ", "ê³„ì•½ê¸°ê°„", "ìš©ì—­ëŒ€ê¸ˆ", "ì™„ë£Œê¸°ì¤€", "ì¸ë„ì¡°ê±´", "ê³„ì•½í•´ì§€", "ìš©ì—­ë‚´ìš©", "ì¶”ê°€ë¹„ìš©", "í’ˆì§ˆê¸°ì¤€", "ë‚©í’ˆì¼ì •", "ê³„ì•½ë³€ê²½", "ê²€ìˆ˜ê¸°ì¤€", "í•˜ìë‹´ë³´", "ë³´ê³ ì˜ë¬´", "ìš©ì—­ì±…ì„", "ê¸°ë°€ìœ ì§€", "ì§€ì ì¬ì‚°ê¶Œ", "ê³„ì•½ì´í–‰", "ì†í•´ë°°ìƒ", "ì¤€ê±°ë²•"],
    "ë§¤ë§¤ê³„ì•½ì„œ": ["ë§¤ë„ì¸", "ë§¤ìˆ˜ì¸", "ë¬¼í’ˆëª…ì„¸", "ì¸ë„ì¡°ê±´", "ëŒ€ê¸ˆì§€ê¸‰ì¼", "í•˜ìë³´ì¦", "ì†Œìœ ê¶Œ ì´ì „", "ê³„ì•½ê¸ˆ", "ì”ê¸ˆ", "ìœ„ì•½ê¸ˆ", "ê±°ë˜ì¡°ê±´", "ë‚©í’ˆê²€ìˆ˜", "ìˆ˜ë ¹ì¦", "ë°˜í’ˆì •ì±…", "ì‚¬ì–‘ì„œ", "ë¬¼í’ˆëŒ€ê¸ˆì²­êµ¬", "ë¬¼ë¥˜ë¹„ìš©", "ìˆ˜ì¶œì…ì‹ ê³ ", "ë¬´ì—­ì¡°ê±´", "êµ­ì œìš´ì†¡", "ì„¸ê¸ˆê³„ì‚°ì„œ"],
    "ì„ëŒ€ì°¨ê³„ì•½ì„œ": ["ì„ëŒ€ì¸", "ì„ì°¨ì¸", "ë³´ì¦ê¸ˆ", "ì„ëŒ€ë£Œ", "ì„ëŒ€ì°¨ ê¸°ê°„", "ê³„ì•½ê°±ì‹ ", "ê´€ë¦¬ë¹„", "ì›ìƒë³µêµ¬", "ì¤‘ë„í•´ì§€", "ì—°ì²´ë£Œ", "ì†í•´ë°°ìƒ", "ì „ëŒ€ê¸ˆì§€", "ê¶Œë¦¬ê¸ˆ", "ì„ëŒ€ëª©ì ë¬¼", "ì‚¬ìš©ìŠ¹ë‚™", "ì¬ê³„ì•½", "ì‚¬ìš©ì œí•œ", "ìœ ì§€ë³´ìˆ˜", "ì¼ì‹œë¶ˆ", "ë¶€ë™ì‚°ë“±ê¸°", "ì‹œì„¤ë¬¼"],
    "ë¹„ë°€ìœ ì§€ê³„ì•½ì„œ": ["ê¸°ë°€ì •ë³´", "ìˆ˜ì‹ ì", "ì œê³µì", "ë¹„ê³µê°œ", "ìœ íš¨ê¸°ê°„", "ì œ3ì ê³µê°œê¸ˆì§€", "ìë£Œë°˜í™˜", "ìœ„ë°˜ì±…ì„", "ì˜ì—…ë¹„ë°€", "ì •ë³´ë³´í˜¸", "ì†í•´ë°°ìƒ", "ë…ë¦½ê°œë°œ", "ë°˜í™˜ì˜ë¬´", "ì‚¬ì „ë™ì˜", "ì •ë³´ì‚¬ìš©ëª©ì ", "ë¹„ê³µê°œì •ë³´", "ê³µê°œë²”ìœ„", "ë³´ì•ˆë“±ê¸‰", "ëª¨ë‹ˆí„°ë§", "ì •ë³´í†µì œ", "ìœ ì¶œë°©ì§€"],
    "ê³µê¸‰ê³„ì•½ì„œ": ["ê³µê¸‰ì—…ì²´", "ë‚©í’ˆê¸°í•œ", "í’ˆì§ˆê´€ë¦¬", "ê³µê¸‰ì¡°ê±´", "ë‚©í’ˆê²€ìˆ˜", "ë‹¨ê°€í˜‘ìƒ", "ì¬ê³ ê´€ë¦¬", "ë¡œíŠ¸ë²ˆí˜¸", "ê³µê¸‰ëŠ¥ë ¥", "í’ˆì§ˆë³´ì¦", "ê²°í•¨ì²˜ë¦¬", "ë‚©ê¸°ì¼ì •", "ê³µê¸‰ì¤‘ë‹¨", "ëŒ€ì²´ê³µê¸‰", "í’ˆì§ˆì¸ì¦", "ì œí’ˆì‚¬ì–‘", "í¬ì¥ê¸°ì¤€", "ìš´ì†¡ì±…ì„", "ìˆ˜ëŸ‰ì¡°ì •", "ê°€ê²©ì¡°ì •"],
    "í”„ëœì°¨ì´ì¦ˆ ê³„ì•½ì„œ": ["ê°€ë§¹ë³¸ë¶€", "ê°€ë§¹ì ", "ê°€ë§¹ê¸ˆ", "ë¡œì—´í‹°", "ì˜ì—…ì§€ì—­", "ìƒí‘œì‚¬ìš©ê¶Œ", "ì˜ì—…ë…¸í•˜ìš°", "ê´‘ê³ ë¶„ë‹´ê¸ˆ", "ë§¤ë‰´ì–¼", "êµìœ¡í›ˆë ¨", "ì í¬ìš´ì˜", "íŒë§¤ëª©í‘œ", "ê³„ì•½í•´ì§€", "ê²½ì—…ê¸ˆì§€", "ì¬ê³„ì•½", "ì í¬ì´ì „", "ì¸í…Œë¦¬ì–´", "ì›ì¬ë£Œ êµ¬ë§¤", "ì˜ì—…ê°ë…", "ë¸Œëœë“œ ê´€ë¦¬"],
    "MOU": ["ì–‘í•´ê°ì„œ", "í˜‘ë ¥ì‚¬í•­", "ì—­í• ë¶„ë‹´", "í˜‘ë ¥ê¸°ê°„", "ë¹„ë°€ìœ ì§€", "ì§€ì ì¬ì‚°ê¶Œ", "ê³µë™ì—°êµ¬", "ì •ë³´ê³µìœ ", "ì˜ì‚¬ê²°ì •", "ë¶„ìŸí•´ê²°", "ê³„ì•½í•´ì§€", "í›„ì†í˜‘ì•½", "í˜‘ë ¥ë²”ìœ„", "ìƒí˜¸í˜‘ë ¥", "ê³µë™ê°œë°œ", "í˜‘ì˜ì‚¬í•­", "ì—…ë¬´í˜‘ì¡°", "í˜‘ë ¥ì²´ê³„", "ì—°ë½ì°½êµ¬", "í‰ê°€ë°©ë²•"],
    "ì£¼ì‹ì–‘ë„ê³„ì•½ì„œ": ["ì–‘ë„ì¸", "ì–‘ìˆ˜ì¸", "ì£¼ì‹ìˆ˜", "ì–‘ë„ê°€ê²©", "ì£¼ì‹ì–‘ë„", "ì£¼ì£¼ê¶Œë¦¬", "ëŒ€ê¸ˆì§€ê¸‰", "ì–‘ë„ì¡°ê±´", "ì£¼ì£¼ì´íšŒ", "ì´ì‚¬íšŒ", "ë°°ë‹¹ê¶Œ", "ì‹ ì£¼ì¸ìˆ˜ê¶Œ", "ê²½ì˜ê¶Œ", "ì£¼ì‹í‰ê°€", "ì‹¤ì‚¬ì™„ë£Œ", "ë‹´ë³´ì œê³µ", "í‘œëª…ë³´ì¥", "ì†í•´ë°°ìƒ", "ì–‘ë„ì œí•œ", "ìš°ì„ ë§¤ìˆ˜ê¶Œ"],
    "ë¼ì´ì„ ìŠ¤ ê³„ì•½ì„œ": ["ë¼ì´ì„ ì„œ", "ë¼ì´ì„ ì‹œ", "íŠ¹í—ˆê¶Œ", "ì‹¤ì‹œë£Œ", "ë…ì ", "ë¹„ë…ì ", "ì‹¤ì‹œë²”ìœ„", "ê¸°ìˆ ì§€ì›", "ê°œëŸ‰ë°œëª…", "ë¼ì´ì„ ìŠ¤ ê¸°ê°„", "ìµœì†Œì‹¤ì‹œë£Œ", "ê¸°ìˆ ì´ì „", "ë…¸í•˜ìš°", "ê°œë°œì„±ê³¼", "ì‚¬ìš©ì œí•œ", "ê¸°ìˆ ì •ë³´", "ì‹¤ì‹œë³´ê³ ", "íŠ¹í—ˆì¶œì›", "ì§€ì ì¬ì‚°ê¶Œ", "ê³„ì•½í•´ì§€"],
    "í•©ì‘íˆ¬ìê³„ì•½ì„œ": ["í•©ì‘ë‹¹ì‚¬ì", "ì¶œìë¹„ìœ¨", "ê²½ì˜ê¶Œ", "ì´ìµë°°ë¶„", "ì†ì‹¤ë¶„ë‹´", "ì´ì‚¬íšŒ", "ê²½ì˜ì§„", "ì¬ë¬´ê´€ë¦¬", "ì˜ì‚¬ê²°ì •", "í•©ì‘íšŒì‚¬", "ì²­ì‚°ì ˆì°¨", "ê³„ì•½í•´ì§€", "ì¶œìì˜ë¬´", "ìë³¸ê¸ˆ", "ê¸°ìˆ ê¸°ì—¬", "ìš´ì˜ê´€ë¦¬", "ê°ì‚¬ê¶Œ", "ì •ë³´ê³µê°œ", "ê²½ìŸì œí•œ", "ë¶„ìŸí•´ê²°"],
    "ìœ„ì„ê³„ì•½ì„œ": ["ìœ„ì„ì", "ìˆ˜ì„ì", "ìœ„ì„ì‚¬ë¬´", "ë³´ìˆ˜", "ìœ„ì„ê¸°ê°„", "ì„ ê´€ì£¼ì˜ì˜ë¬´", "ë³´ê³ ì˜ë¬´", "ê³„ì‚°ì„œ ì œì¶œ", "ë¹„ìš©ì •ì‚°", "ëŒ€ë¦¬ê¶Œ", "ë³µìœ„ì„", "ìœ„ì„í•´ì§€", "ì†í•´ë°°ìƒ", "ê¸°ë°€ìœ ì§€", "ì´í•´ìƒì¶©", "ìˆ˜ì„ë£Œ", "ê²½ë¹„ë¶€ë‹´", "ì—…ë¬´ë²”ìœ„", "ê¶Œí•œë²”ìœ„", "ì±…ì„í•œê³„"],
    "ê¸°ìˆ ì´ì „ê³„ì•½ì„œ": ["ê¸°ìˆ ì œê³µì", "ê¸°ìˆ ë„ì…ì", "ê¸°ìˆ ë£Œ", "ê¸°ìˆ ë²”ìœ„", "ê¸°ìˆ ë¬¸ì„œ", "ê¸°ìˆ ì§€ë„", "ê°œëŸ‰ê¸°ìˆ ", "íŠ¹í—ˆì¶œì›", "ë…¸í•˜ìš°", "ê¸°ìˆ í‰ê°€", "ê¸°ìˆ ê²€ì¦", "ì‹¤ì‹œê¶Œ", "ë…ì ê¶Œ", "ê¸°ìˆ ì§€ì›", "êµìœ¡í›ˆë ¨", "ê¸°ìˆ ê°œë°œ", "ì„±ê³¼ë°°ë¶„", "ê¸°ìˆ ë³´ì¦", "ê³„ì•½í•´ì§€", "ê²½ì—…ê¸ˆì§€"],
    "í•˜ë„ê¸‰ê³„ì•½ì„œ": ["ì›ë„ê¸‰ì", "í•˜ë„ê¸‰ì", "í•˜ë„ê¸‰ëŒ€ê¸ˆ", "ê³µì‚¬ê¸°ê°„", "ì‹œê³µë²”ìœ„", "í’ˆì§ˆê¸°ì¤€", "ì•ˆì „ê´€ë¦¬", "ì§„ë„ê´€ë¦¬", "ê²€ì‚¬ê¸°ì¤€", "ê¸°ì„±ê³ ", "í•˜ìë³´ìˆ˜", "ê³„ì•½ë³€ê²½", "ê³µì‚¬ì¤‘ë‹¨", "í•˜ë„ê¸‰ë²•", "ì§€ê¸‰ë³´ì¦", "ì´í–‰ë³´ì¦", "ì„¤ê³„ë³€ê²½", "ê³µê¸°ì—°ì¥", "ì†í•´ë°°ìƒ", "ë³´í—˜ê°€ì…"],
    "ê´‘ê³ ëŒ€í–‰ê³„ì•½ì„œ": ["ê´‘ê³ ì£¼", "ê´‘ê³ ëŒ€í–‰ì‚¬", "ê´‘ê³ ë¹„", "ê´‘ê³ ê¸°ê°„", "ë§¤ì²´ì„ ì •", "ê´‘ê³ íš¨ê³¼", "í¬ë¦¬ì—ì´í‹°ë¸Œ", "ë§¤ì²´ìˆ˜ìˆ˜ë£Œ", "ê´‘ê³ ìŠ¹ì¸", "ê´‘ê³ ê²°ê³¼", "ì˜ˆì‚°ê´€ë¦¬", "ê´‘ê³ ì „ëµ", "íƒ€ê²ŸíŒ…", "ê´‘ê³ í‰ê°€", "ì €ì‘ê¶Œ", "ì´ˆìƒê¶Œ", "ê´‘ê³ ìœ¤ë¦¬", "ê³„ì•½í•´ì§€", "ì†í•´ë°°ìƒ", "ê¸°ë°€ìœ ì§€"],
    "ì»¨ì„¤íŒ…ê³„ì•½ì„œ": ["ì»¨ì„¤í„´íŠ¸", "í´ë¼ì´ì–¸íŠ¸", "ì»¨ì„¤íŒ…ë£Œ", "ì»¨ì„¤íŒ… ê¸°ê°„", "ì»¨ì„¤íŒ… ë²”ìœ„", "ì„±ê³¼ë¬¼", "ë³´ê³ ì„œ", "ì»¨ì„¤íŒ… ë°©ë²•", "ì „ë¬¸ì„±", "ê¸°ë°€ìœ ì§€", "ì´í•´ìƒì¶©", "ì±…ì„í•œê³„", "ì„±ê³¼ë³´ì¥", "ì¶”ê°€ë¹„ìš©", "ì§€ì ì¬ì‚°ê¶Œ", "ê²½ìŸì œí•œ", "ê³„ì•½í•´ì§€", "ì†í•´ë°°ìƒ", "ë¶„ìŸí•´ê²°", "ì¤€ê±°ë²•"],
    "ì¶œíŒê³„ì•½ì„œ": ["ì €ì‘ì", "ì¶œíŒì‚¬", "ì¸ì„¸", "ì¶œê°„ì¼", "íŒê¶Œ", "ì €ì‘ê¶Œ", "í¸ì§‘ê¶Œ", "ë°°í¬ê¶Œ", "ë²ˆì—­ê¶Œ", "2ì°¨ ì €ì‘ë¬¼", "ìµœì†Œì¶œê°„ë¶€ìˆ˜", "ì ˆíŒê¸°ì¤€", "ì¬ì¶œê°„", "ê´‘ê³ í™ë³´", "ë§ˆì¼€íŒ…", "ì €ì‘ì¸ê²©ê¶Œ", "ìˆ˜ì •ê¶Œ", "ê²€ì—´ê¸ˆì§€", "ê³„ì•½í•´ì§€", "ì†í•´ë°°ìƒ"],
    "ê±´ì„¤ê³µì‚¬ê³„ì•½ì„œ": ["ë°œì£¼ì", "ìˆ˜ê¸‰ì¸", "ê³µì‚¬ëŒ€ê¸ˆ", "ê³µì‚¬ê¸°ê°„", "ì„¤ê³„ë„ì„œ", "ì‹œë°©ì„œ", "í’ˆì§ˆê´€ë¦¬", "ì•ˆì „ê´€ë¦¬", "ì¤€ê³µê²€ì‚¬", "í•˜ìë‹´ë³´", "ê¸°ì„±ê³ ", "ì„ ê¸‰ê¸ˆ", "ê³µì‚¬ë³€ê²½", "ê³µê¸°ì—°ì¥", "ê³„ì•½í•´ì§€", "ì†í•´ë°°ìƒ", "ì´í–‰ë³´ì¦", "í•˜ìë³´ìˆ˜", "ë³´í—˜ê°€ì…", "í•˜ë„ê¸‰"],
    "ì„ì˜ê·œì•½ê³„ì•½ì„œ": ["ë‹¹ì‚¬ì", "í•©ì˜ì‚¬í•­", "ì´í–‰ì¡°ê±´", "ê³„ì•½ê¸°ê°„", "ê¶Œë¦¬ì˜ë¬´", "íŠ¹ì•½ì‚¬í•­", "ë©´ì±…ì¡°í•­", "ë¶ˆê°€í•­ë ¥", "ê³„ì•½ë³€ê²½", "ê³„ì•½í•´ì§€", "ë¶„ìŸí•´ê²°", "ì¤€ê±°ë²•", "ê´€í• ë²•ì›", "í†µì§€ì˜ë¬´", "ìŠ¹ê³„ê¸ˆì§€", "ê³„ì•½ì˜ íš¨ë ¥", "í•´ì„ê¸°ì¤€", "ìš°ì„ ìˆœìœ„", "ë¶€ì†í•©ì˜", "ì™„ì „í•©ì˜"],
    "íˆ¬ìê³„ì•½ì„œ": ["íˆ¬ìì", "í”¼íˆ¬ìíšŒì‚¬", "íˆ¬ìê¸ˆì•¡", "ì£¼ì‹ì¸ìˆ˜", "ê¸°ì—…ê°€ì¹˜", "ìš°ì„ ì£¼", "ì „í™˜ê¶Œ", "í¬ì„ë°©ì§€", "íˆ¬ìì¡°ê±´", "ê²½ì˜ì°¸ì—¬", "ì •ë³´ì œê³µ", "ìŠ¹ì¸ì‚¬í•­", "ìš°ì„ ì²­ì‚°ê¶Œ", "ë™ë°˜ë§¤ë„ê¶Œ", "ìš°ì„ ë§¤ìˆ˜ê¶Œ", "ê²½ì—…ê¸ˆì§€", "í‚¤ë§¨ì¡°í•­", "íˆ¬ìíšŒìˆ˜", "IPO", "M&A"]
}

CONTRACT_TYPE_DESCRIPTIONS = {
    "ê·¼ë¡œê³„ì•½ì„œ": "ê³ ìš©ì£¼ì™€ ê·¼ë¡œì ê°„ì˜ ê·¼ë¡œê´€ê³„ë¥¼ ì •í•˜ëŠ” ê³„ì•½ì„œ",
    "ìš©ì—­ê³„ì•½ì„œ": "íŠ¹ì • ì„œë¹„ìŠ¤ë‚˜ ì—…ë¬´ì˜ ì œê³µì— ê´€í•œ ê³„ì•½ì„œ",
    "ë§¤ë§¤ê³„ì•½ì„œ": "ë¬¼í’ˆì´ë‚˜ ì¬ì‚°ì˜ ë§¤ë§¤ì— ê´€í•œ ê³„ì•½ì„œ",
    "ì„ëŒ€ì°¨ê³„ì•½ì„œ": "ë¶€ë™ì‚°ì´ë‚˜ ë¬¼ê±´ì˜ ì„ëŒ€ì°¨ì— ê´€í•œ ê³„ì•½ì„œ",
    "ë¹„ë°€ìœ ì§€ê³„ì•½ì„œ": "ê¸°ë°€ì •ë³´ì˜ ë³´í˜¸ì™€ ê´€ë¦¬ì— ê´€í•œ ê³„ì•½ì„œ",
    "ê³µê¸‰ê³„ì•½ì„œ": "ì§€ì†ì ì¸ ë¬¼í’ˆì´ë‚˜ ì„œë¹„ìŠ¤ ê³µê¸‰ì— ê´€í•œ ê³„ì•½ì„œ",
    "í”„ëœì°¨ì´ì¦ˆ ê³„ì•½ì„œ": "ê°€ë§¹ì‚¬ì—…ì— ê´€í•œ ê¶Œë¦¬ì™€ ì˜ë¬´ë¥¼ ì •í•˜ëŠ” ê³„ì•½ì„œ",
    "MOU": "ìƒí˜¸ í˜‘ë ¥ê³¼ ì–‘í•´ì— ê´€í•œ ê°ì„œ",
    "ì£¼ì‹ì–‘ë„ê³„ì•½ì„œ": "ì£¼ì‹ì˜ ì–‘ë„ì™€ ë§¤ë§¤ì— ê´€í•œ ê³„ì•½ì„œ",
    "ë¼ì´ì„ ìŠ¤ ê³„ì•½ì„œ": "ì§€ì ì¬ì‚°ê¶Œì˜ ì‚¬ìš©í—ˆê°€ì— ê´€í•œ ê³„ì•½ì„œ",
    "í•©ì‘íˆ¬ìê³„ì•½ì„œ": "ê³µë™íˆ¬ìì™€ ì‚¬ì—…ìš´ì˜ì— ê´€í•œ ê³„ì•½ì„œ",
    "ìœ„ì„ê³„ì•½ì„œ": "íŠ¹ì • ì—…ë¬´ì˜ ìœ„ì„ì— ê´€í•œ ê³„ì•½ì„œ",
    "ê¸°ìˆ ì´ì „ê³„ì•½ì„œ": "ê¸°ìˆ ê³¼ ë…¸í•˜ìš°ì˜ ì´ì „ì— ê´€í•œ ê³„ì•½ì„œ",
    "í•˜ë„ê¸‰ê³„ì•½ì„œ": "ê±´ì„¤ì´ë‚˜ ì œì¡°ì—…ì˜ í•˜ë„ê¸‰ì— ê´€í•œ ê³„ì•½ì„œ",
    "ê´‘ê³ ëŒ€í–‰ê³„ì•½ì„œ": "ê´‘ê³ ì—…ë¬´ì˜ ëŒ€í–‰ì— ê´€í•œ ê³„ì•½ì„œ",
    "ì»¨ì„¤íŒ…ê³„ì•½ì„œ": "ì „ë¬¸ì ì¸ ì¡°ì–¸ê³¼ ì»¨ì„¤íŒ…ì— ê´€í•œ ê³„ì•½ì„œ",
    "ì¶œíŒê³„ì•½ì„œ": "ì €ì‘ë¬¼ì˜ ì¶œê°„ê³¼ ë°°í¬ì— ê´€í•œ ê³„ì•½ì„œ",
    "ê±´ì„¤ê³µì‚¬ê³„ì•½ì„œ": "ê±´ì„¤ê³µì‚¬ì˜ ì‹œí–‰ì— ê´€í•œ ê³„ì•½ì„œ",
    "ì„ì˜ê·œì•½ê³„ì•½ì„œ": "ë‹¹ì‚¬ì ê°„ì˜ íŠ¹ë³„í•œ ì•½ì •ì— ê´€í•œ ê³„ì•½ì„œ",
    "íˆ¬ìê³„ì•½ì„œ": "íˆ¬ìì™€ ì§€ë¶„ì°¸ì—¬ì— ê´€í•œ ê³„ì•½ì„œ"
}

class DocumentProcessor:
    """ë¬¸ì„œ ì²˜ë¦¬ í´ë˜ìŠ¤"""
    
    @staticmethod
    def extract_text_from_file(file_path: str, file_name: str) -> str:
        """íŒŒì¼ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ"""
        file_ext = file_name.lower().split('.')[-1]
        try:
            if file_ext == 'pdf':
                with open(file_path, 'rb') as f:
                    reader = PyPDF2.PdfReader(f)
                    return "\n".join([page.extract_text() for page in reader.pages])
            elif file_ext == 'docx':
                doc = docx.Document(file_path)
                return "\n".join([paragraph.text for paragraph in doc.paragraphs])
            elif file_ext == 'txt':
                with open(file_path, 'r', encoding='utf-8') as f:
                    return f.read()
            else:
                return "âŒ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤."
        except Exception as e:
            return f"âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {str(e)}"

    @staticmethod
    def detect_contract_type(text: str) -> Tuple[Optional[str], Optional[Dict], Dict]:
        """ê³„ì•½ì„œ ìœ í˜• ìë™ ê°ì§€"""
        print("ğŸ¯ ê³„ì•½ì„œ ìœ í˜• ìë™ ê°ì§€ ì‹œì‘...")

        type_scores = {}
        for contract_type, terms in CONTRACT_TYPES_TERMS.items():
            score = 0
            matched_terms = []

            for term in terms:
                if term in text:
                    score += 1
                    matched_terms.append(term)

            if score > 0:
                type_scores[contract_type] = {
                    'score': score,
                    'percentage': round((score / len(terms)) * 100, 1),
                    'matched_terms': matched_terms
                }

        if type_scores:
            sorted_types = sorted(type_scores.items(), key=lambda x: x[1]['score'], reverse=True)
            detected_type = sorted_types[0][0]
            confidence = sorted_types[0][1]

            print(f"âœ… ê°ì§€ëœ ê³„ì•½ì„œ ìœ í˜•: {detected_type} ({confidence['percentage']}%)")
            return detected_type, confidence, dict(sorted_types)
        else:
            print("âŒ ê³„ì•½ì„œ ìœ í˜•ì„ ê°ì§€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            return None, None, {}

    @staticmethod
    def extract_articles_with_content(text: str) -> List[Dict]:
        """ì¡°í•­ë³„ ì •ë°€ ì¶”ì¶œ"""
        print("ğŸ“„ ì¡°í•­ë³„ ì •ë°€ ì¶”ì¶œ ì‹œì‘...")

        chunks = []
        article_pattern = r'ì œ\s*(\d+)\s*ì¡°\s*\(([^)]+)\)'
        articles = list(re.finditer(article_pattern, text))

        print(f"ğŸ” ë°œê²¬ëœ ì¡°í•­: {len(articles)}ê°œ")

        if articles:
            for i, article in enumerate(articles):
                article_num = int(article.group(1))
                article_title = article.group(2).strip()
                start_pos = article.start()

                if i + 1 < len(articles):
                    end_pos = articles[i + 1].start()
                else:
                    end_pos = len(text)

                full_content = text[start_pos:end_pos].strip()
                lines = full_content.split('\n')
                header = lines[0] if lines else ""
                body = '\n'.join(lines[1:]) if len(lines) > 1 else ""

                if len(full_content) > 10:
                    chunk_data = {
                        'text': full_content,
                        'article_num': article_num,
                        'article_title': article_title,
                        'header': header,
                        'body': body,
                        'type': 'article'
                    }
                    chunks.append(chunk_data)
                    print(f"âœ… ì œ{article_num}ì¡°({article_title}) ì¶”ì¶œ: {len(full_content)}ì")

        # ì¡°í•­ì´ ë¶€ì¡±í•œ ê²½ìš° ë¬¸ë‹¨ë³„ ì¶”ê°€
        if len(chunks) < 5:
            print("ğŸ“‹ ì¡°í•­ì´ ë¶€ì¡±í•˜ì—¬ ë¬¸ë‹¨ë³„ ë³´ì™„...")
            paragraphs = [p.strip() for p in text.split('\n') if len(p.strip()) > 50]

            for i, para in enumerate(paragraphs[:10]):
                chunks.append({
                    'text': para,
                    'article_num': None,
                    'article_title': f"ë¬¸ë‹¨ {i+1}",
                    'header': para[:50] + "...",
                    'body': para,
                    'type': 'paragraph'
                })

        print(f"âœ… ì´ {len(chunks)}ê°œ ì²­í¬ ìƒì„±")
        return chunks

    @staticmethod
    def extract_key_contract_info(text: str) -> Dict:
        """ê³„ì•½ì„œì—ì„œ í•µì‹¬ ì •ë³´ ì¶”ì¶œ"""
        info = {
            'contract_type': None,
            'keywords': [],
            'financial_terms': [],
            'period_terms': []
        }

        # ê³„ì•½ ìœ í˜• ê°ì§€
        for contract_type in CONTRACT_TYPES_TERMS.keys():
            if any(term in text for term in CONTRACT_TYPES_TERMS[contract_type][:3]):
                info['contract_type'] = contract_type
                break

        # í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ
        # ê¸ˆì•¡ ê´€ë ¨ ìš©ì–´
        financial_pattern = r'(ëŒ€ê¸ˆ|ë¹„ìš©|ìš”ê¸ˆ|ìˆ˜ìˆ˜ë£Œ|ë³´ì¦ê¸ˆ|ìœ„ì•½ê¸ˆ|ì—°ì²´ë£Œ|ì§€ì²´ìƒê¸ˆ|ê³„ì•½ê¸ˆ|ì”ê¸ˆ)'
        info['financial_terms'] = list(set(re.findall(financial_pattern, text)))

        # ê¸°ê°„ ê´€ë ¨ ìš©ì–´
        period_pattern = r'(ê¸°ê°„|ê¸°í•œ|ì¼ì|ë‚ ì§œ|ì‹œì |ì‹œê¸°|ì™„ë£Œ|ì¢…ë£Œ|ë§Œë£Œ)'
        info['period_terms'] = list(set(re.findall(period_pattern, text)))

        # ì¼ë°˜ í‚¤ì›Œë“œ
        general_keywords = ['ê³„ì•½', 'ë‹¹ì‚¬ì', 'ì˜ë¬´', 'ê¶Œë¦¬', 'ì±…ì„', 'ì¡°ê±´', 'ê¸°ì¤€', 'ë°©ë²•']
        info['keywords'] = [kw for kw in general_keywords if kw in text]

        return info

    @staticmethod
    def extract_detailed_risk_info(text: str) -> Dict:
        """ìƒì„¸í•œ ìœ„í—˜ ê´€ë ¨ ì •ë³´ ì¶”ì¶œ"""
        risk_info = {
            'risk_keywords': [],
            'liability_terms': [],
            'termination_terms': [],
            'obligation_terms': [],
            'penalty_terms': []
        }

        # ì†í•´ë°°ìƒ ê´€ë ¨
        liability_pattern = r'(ì†í•´ë°°ìƒ|ë°°ìƒì±…ì„|ë°°ìƒì˜ë¬´|ì†ì‹¤ë³´ìƒ|í”¼í•´ë³´ìƒ|ì†í•´|ë°°ìƒ)'
        risk_info['liability_terms'] = list(set(re.findall(liability_pattern, text)))

        # í•´ì§€ ê´€ë ¨
        termination_pattern = r'(í•´ì§€|í•´ì œ|ì¢…ë£Œ|ì¤‘ë‹¨|íŒŒê¸°|ì·¨ì†Œ|ì² íšŒ)'
        risk_info['termination_terms'] = list(set(re.findall(termination_pattern, text)))

        # ì˜ë¬´ ê´€ë ¨
        obligation_pattern = r'(ì˜ë¬´|ì±…ì„|ì´í–‰|ì¤€ìˆ˜|ì™„ìˆ˜|ìˆ˜í–‰|ì‹¤í–‰)'
        risk_info['obligation_terms'] = list(set(re.findall(obligation_pattern, text)))

        # ì œì¬ ê´€ë ¨
        penalty_pattern = r'(ìœ„ì•½ê¸ˆ|ì—°ì²´ë£Œ|ì§€ì²´ìƒê¸ˆ|ë²Œê¸ˆ|ê³¼íƒœë£Œ|ì œì¬|ì²˜ë²Œ|ì§•ê³„)'
        risk_info['penalty_terms'] = list(set(re.findall(penalty_pattern, text)))

        # ì „ì²´ ìœ„í—˜ í‚¤ì›Œë“œ
        risk_info['risk_keywords'] = (
            risk_info['liability_terms'] +
            risk_info['termination_terms'] +
            risk_info['penalty_terms']
        )

        return risk_info